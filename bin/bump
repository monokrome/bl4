#!/bin/bash
set -euo pipefail

# Usage: bump [-m|-M] [--tag] [--push]
#   (default) - patch bump (0.5.3 -> 0.5.4)
#   -m        - minor bump (0.5.3 -> 0.6.0)
#   -M        - major bump (0.5.3 -> 1.0.0)
#   --tag     - create git tag after bump
#   --push    - push commits and tags

BUMP_TYPE="patch"
DO_TAG=false
DO_PUSH=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -m|m) BUMP_TYPE="minor"; shift ;;
        -M|M) BUMP_TYPE="major"; shift ;;
        -p|p) BUMP_TYPE="patch"; shift ;;
        --tag) DO_TAG=true; shift ;;
        --push) DO_PUSH=true; shift ;;
        -h|--help)
            echo "Usage: bump [-m|-M] [--tag] [--push]"
            echo "  (default)  patch bump (0.5.3 -> 0.5.4)"
            echo "  -m         minor bump (0.5.3 -> 0.6.0)"
            echo "  -M         major bump (0.5.3 -> 1.0.0)"
            echo "  --tag      create git tag after bump"
            echo "  --push     push commits and tags"
            exit 0
            ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
done

# Get repo root
REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$REPO_ROOT"

# Parse current version
CURRENT=$(grep -m1 '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

echo "Current version: $CURRENT"

# Calculate new version
case $BUMP_TYPE in
    patch) NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))" ;;
    minor) NEW_VERSION="$MAJOR.$((MINOR + 1)).0" ;;
    major) NEW_VERSION="$((MAJOR + 1)).0.0" ;;
esac

echo "New version: $NEW_VERSION ($BUMP_TYPE bump)"

# Extract new major.minor for dependency refs
IFS='.' read -r NEW_MAJOR NEW_MINOR _ <<< "$NEW_VERSION"
NEW_MM="$NEW_MAJOR.$NEW_MINOR"
OLD_MM="$MAJOR.$MINOR"

# Update root Cargo.toml
sed -i "s/^version = \"$CURRENT\"/version = \"$NEW_VERSION\"/" Cargo.toml
echo "Updated Cargo.toml"

# Update internal dependency versions if minor/major changed
if [[ "$NEW_MM" != "$OLD_MM" ]]; then
    echo "Minor version changed ($OLD_MM -> $NEW_MM), updating internal deps..."

    for toml in src/*/Cargo.toml; do
        if grep -q "version = \"$OLD_MM\"" "$toml" 2>/dev/null; then
            sed -i "s/version = \"$OLD_MM\"/version = \"$NEW_MM\"/g" "$toml"
            echo "  Updated $toml"
        fi
    done
fi

# Update Cargo.lock
echo "Updating Cargo.lock..."
cargo update --workspace >/dev/null 2>&1 || true

# Verify it builds
echo "Verifying build..."
if ! cargo check --workspace --exclude bl4-save-editor 2>/dev/null; then
    echo "Build check failed! Rolling back..."
    git checkout Cargo.toml src/*/Cargo.toml Cargo.lock
    exit 1
fi

# Commit
git add Cargo.toml Cargo.lock src/*/Cargo.toml 2>/dev/null || git add Cargo.toml Cargo.lock
git commit -m "chore: bump version to $NEW_VERSION"
echo "Committed version bump"

# Tag
if $DO_TAG; then
    git tag "v$NEW_VERSION"
    echo "Created tag v$NEW_VERSION"
fi

# Push
if $DO_PUSH; then
    git push
    if $DO_TAG; then
        git push origin "v$NEW_VERSION"
    fi
    echo "Pushed to origin"
fi

echo ""
echo "Done! Version bumped to $NEW_VERSION"
if ! $DO_TAG; then
    echo ""
    echo "To release, run:"
    echo "  git tag v$NEW_VERSION && git push && git push origin v$NEW_VERSION"
fi
