# Borderlands 4 Data Formats

This document describes the data formats used in BL4 game files and how to extract them.

## Data Sources

### 1. Extracted Game Files (our extraction)

Using `retoc` to unpack `.utoc/.ucas` containers gives us raw `.uasset` files. From these we can extract:

- **Property names and GUIDs** via `strings` command
- **Stat patterns**: `StatName_ModifierType_Index_GUID`
- **Structural data** (manufacturers, weapon types, categories)

**Limitations**: The `strings` command cannot extract:
- Localized text (FText)
- Numeric values embedded in binary data
- Complex nested structures

### 2. DataTable Exports (external source)

The `complete_parts_viewer.html` file was generated by a **Unreal DataTable export tool**. These tools can:

- Parse `.uasset` binary format properly
- Resolve FText references to actual strings
- Extract numeric values from properties
- Export nested DataTable rows

## HTML Export Format

The HTML file contains DataTable data with this structure:

### Part Entry
```html
<div class="part-card">
  <span class="number-label">#516</span>
  <div class="part-name">mags</div>
  <!-- Stats follow -->
</div>
```

- `#N` - Part index (used in item serial encoding)
- Part name - Internal name or DataTable row name

### Named Parts with Asset References
```html
<div class="part-name">BorgHeavyWeaponNamingBodyPrefix (/Script/OakGame.HeavyWeaponNamingRow) 2559-3477 (918 bits)</div>
```

Format: `PartName (AssetPath) BitStart-BitEnd (BitSize)`

- **AssetPath**: UE asset reference (e.g., `/Script/OakGame.HeavyWeaponNamingRow`)
- **Bit range**: Position in serialized data structure

### Stat Values

#### Numeric Stats
```html
<span class="stat-name">damage_scale:</span>
<span class="stat-value">1.3</span>
```

#### Object References (Nested)
```html
<span class="stat-name">DAD_Mag_01:</span>
<span class="stat-value">[Object]</span>
```

Followed by nested `<div class="nested-stats">` containing child properties.

#### NexusSerialized Format
```html
<span class="stat-name">damage:</span>
<span class="stat-value">NexusSerialized, 41416493050640128E5A8AA40911162C, Tortuous</span>
```

Format: `NexusSerialized, GUID, DisplayText`

- **NexusSerialized**: Marker indicating serialized reference
- **GUID**: Asset identifier (32 hex chars)
- **DisplayText**: Resolved FText string (weapon prefix name)

## Data Categories

### Part Types

| Category | Description | Example Parts |
|----------|-------------|---------------|
| `mags` | Magazine definitions | DAD_Mag_01, JAK_Mag_02 |
| `barrels` | Barrel modifiers | BOR_Barrel_01, VLA_Barrel_02 |
| `grips` | Grip attachments | Grip_Acc_Default |
| `underbarrels` | Underbarrel accessories | AR_Underbarrel_01 |

### Stat Modifiers

| Modifier | Type | Description |
|----------|------|-------------|
| `damage_scale` | float | Damage multiplier |
| `firerate_scale` | float | Fire rate multiplier |
| `reloadtime_value` | float | Reload time (seconds) |
| `maxloadedammo_value` | float | Magazine capacity |
| `spread_scale` | float | Spread multiplier |
| `accuracy_scale` | float | Accuracy multiplier |
| `recoil_scale` | float | Recoil multiplier |
| `sway_scale` | float | Sway multiplier |
| `heatimpulse_value` | float | Heat per shot |

### Naming Tables

Naming tables map part combinations to weapon prefix names:

```
Part Index → Primary Stat → Secondary Stat → Prefix Name
```

Example from `WeaponNamingStruct`:
- Index 2 (Damage) + accuracy → "Invasive"
- Index 2 (Damage) + critdamage → "Eviscerating"
- Index 2 (Damage) + single → "Agonizing"

## GUID Format

GUIDs in BL4 follow the Unreal Engine format:
```
XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
```

Stored in game files as 32 hex characters without dashes:
```
41416493050640128E5A8AA40911162C
```

These reference:
- Asset objects (DataTable rows)
- FText string table entries
- Blueprint references

## Extracting This Data

### Method 1: UAssetGUI (Legacy format only)

[UAssetGUI](https://github.com/atenfyr/UAssetGUI) requires legacy format files.

1. Convert Zen→Legacy with `retoc to-legacy`
2. Open extracted `.uasset` files
3. Navigate to DataTable exports
4. Export data

**Limitation**: `unreal_asset` Rust crate only supports up to UE5.2. UAssetAPI (.NET) supports up to UE5.4. BL4 uses UE5.5, so neither can parse the converted files.

### Method 3: retoc Library (Rust)

The `retoc` crate provides programmatic access to IoStore containers.

**Add to Cargo.toml:**
```toml
[dependencies]
retoc = { git = "https://github.com/trumank/retoc" }
```

**Capabilities:**
- ✅ Read `.utoc/.ucas` containers directly
- ✅ Parse Zen package headers (name maps, imports, exports)
- ✅ Convert Zen→Legacy format
- ✅ Handle Oodle compression and AES encryption
- ❌ Full property serialization (DataTable row values)
- ❌ FText string resolution

**Example:**
```rust
use retoc::{Toc, Config, FSFileReader};
use std::sync::Arc;
use std::fs::File;
use std::io::BufReader;

fn read_toc(utoc_path: &str) -> anyhow::Result<()> {
    let config = Arc::new(Config::default());
    let file = File::open(utoc_path)?;
    let mut reader = BufReader::new(file);
    let toc: Toc = retoc::ser::ReadExt::de_ctx(&mut reader, config)?;

    // List all files
    for (path, _) in &toc.file_map {
        println!("{}", path);
    }
    Ok(())
}
```

### Method 4: Our bl4-research Tool

For structural data without resolved strings:
```bash
# Extract all manifest data
bl4-research manifest

# Search for patterns in assets
bl4-research strings /tmp/bl4_extract/path/to/assets -p "pattern"
```

## File Locations

### Key DataTables

| Asset Path | Contents |
|------------|----------|
| `/Game/Gear/Weapons/_Shared/NamingStrategies/WeaponNamingStruct` | Weapon prefix naming table |
| `/Game/Gear/Weapons/_Shared/NamingStrategies/DAD_LicensedPart_Table_Struct` | Daedalus licensed parts |
| `/Game/Gear/Weapons/_Shared/NamingStrategies/TED_PayloadPrefix_Table_Struct` | Tediore payload prefixes |
| `/Game/GameData/DataTables/Structs/Struct_BaseDamage` | Class mod stat tables |

### Balance Data

| Asset Path | Contents |
|------------|----------|
| `/Game/Gear/Weapons/_Shared/BalanceData/BarrelData/*` | Barrel stat modifiers |
| `/Game/Gear/Weapons/_Shared/BalanceData/MagazineData/*` | Magazine stat modifiers |
| `/Game/Gear/Weapons/_Shared/BalanceData/Rarity/*` | Rarity tier modifiers |
| `/Game/Gear/Weapons/_Shared/BalanceData/Elemental/*` | Elemental damage data |

## Converting HTML to JSON

The `tools/html_to_json.py` script parses the HTML export:

```bash
python tools/html_to_json.py
```

Input: `share/complete_parts_viewer.html`
Output: `share/parts.json`

The script:
1. Extracts part cards with indices and names
2. Parses nested stat structures
3. Converts `NexusSerialized` arrays to structured objects
4. Extracts bit ranges from part names

## JSON Output Format

```json
{
  "index": 2,
  "name": "Damage",
  "stats": {
    "accuracy": {
      "asset_id": "5E23AD3CA13F4CC8AAE6F9108D2973E9",
      "prefix": "Invasive"
    },
    "critdamage": {
      "asset_id": "0F49EFBCEC384B5EB8826386759AF94B",
      "prefix": "Eviscerating"
    }
  }
}
```

For parts with bit ranges:
```json
{
  "index": 6,
  "name": "BorgHeavyWeaponNamingBodyPrefix",
  "asset_path": "/Script/OakGame.HeavyWeaponNamingRow",
  "bit_start": 2559,
  "bit_end": 3477,
  "categories": { ... }
}
```

## Related Documentation

- [extraction.md](extraction.md) - Game file extraction process
- [data_structures.md](data_structures.md) - Item serial encoding format
